#ifndef ROOM_DATA_H
#define ROOM_DATA_H

#define ROOM_WIDTH 774
#define ROOM_HEIGHT 774

#define ROOM_LEVEL_COUNT 3

static room_gen_t ROOM_TEMPLATES[14]={
  {8, 0,
    ROOM_SIZE_XL | ROOM_LAYOUT_OPEN | ROOM_PURPOSE_LAIR |
      ROOM_SHAPE_SQUARE | ROOM_PLACING_W},
  {
    10, 1,
    ROOM_LAYOUT_HALL | ROOM_SIZE_MASSIVE | ROOM_PURPOSE_CONNECT |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_VER | ROOM_PLACING_N,{&ROOM_TEMPLATES[0]}
  },
  {10, 1,
    ROOM_LAYOUT_HALL | ROOM_SIZE_MASSIVE | ROOM_PURPOSE_CONNECT |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_VER | ROOM_PLACING_S,
    {&ROOM_TEMPLATES[4]}
  },
  {8, 2,
    ROOM_LAYOUT_HALL | ROOM_SIZE_HUGE | ROOM_PURPOSE_CONNECT |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_HOR | ROOM_PLACING_E,{&ROOM_TEMPLATES[1],&ROOM_TEMPLATES[2]}
  },
  {10,0,
      ROOM_LAYOUT_OPEN | ROOM_SIZE_HUGE | ROOM_PURPOSE_CHALLENGE |
      ROOM_SHAPE_RECT | ROOM_PLACING_S | ROOM_ORIENT_VER
  },
  {5, 0 ,
    ROOM_LAYOUT_OPEN | ROOM_SIZE_HUGE | ROOM_PURPOSE_CONNECT | 
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_HOR | ROOM_PLACING_E,
  },
  {5, 1,
    ROOM_LAYOUT_OPEN | ROOM_SIZE_HUGE | ROOM_PURPOSE_CHALLENGE |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_VER | ROOM_PLACING_S,
    {&ROOM_TEMPLATES[9]}
  },
  {7, 1,
    ROOM_LAYOUT_OPEN | ROOM_SIZE_MASSIVE | ROOM_PURPOSE_CONNECT |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_VER | ROOM_PLACING_N,
    {&ROOM_TEMPLATES[8]}
  },
  {5, 0,
    ROOM_LAYOUT_OPEN | ROOM_SIZE_MAX | ROOM_PURPOSE_CAMP |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_VER | ROOM_PLACING_W
  },
  {2, 1,
    ROOM_LAYOUT_ROOM | ROOM_SIZE_MEDIUM | ROOM_PURPOSE_EXIT |
      ROOM_SHAPE_RECT | ROOM_ORIENT_HOR | ROOM_PLACING_S,
    {&ROOM_TEMPLATES[10]}},
  {2, 0,
    ROOM_LAYOUT_ROOM | ROOM_SIZE_MEDIUM | ROOM_PURPOSE_SPAWN |
      ROOM_SHAPE_SQUARE | ROOM_ORIENT_HOR | ROOM_PLACING_E}
};

static map_gen_t MAPS[MAP_DONE]= {
  {DARK_FOREST, BIO_FOREST, 1.75, 0.25f,
    MAPFLAG_FOREST, 1, 5, 0, TILEFLAG_FLOOR,
    .mobs = {
      MOB_LOC_FOREST | MOB_FREQ_COMMON |
      MOB_THEME_CRITTER | MOB_THEME_PRIMITIVE | MOB_THEME_PRED | MOB_THEME_GAME | 
      MOB_GROUPING_MASK | MOB_MOD_MASK | MOB_SPAWN_MASK
    },
    2,
    {
      4, 4,
      ROOM_SIZE_HUGE | ROOM_LAYOUT_OPEN | ROOM_PLACING_E |
        ROOM_PURPOSE_START | ROOM_SHAPE_SQUARE,
      {&ROOM_TEMPLATES[5],&ROOM_TEMPLATES[6],&ROOM_TEMPLATES[7],&ROOM_TEMPLATES[0]}
    },
    MN_GRID,
  
  },
  {DANK_DUNGEON, BIO_DUNGEON, 0.75,2.0f,
    MAPFLAG_DUNGEON, 2,20,36, TILEFLAG_DOOR,
    .mobs={
      MOB_LOC_DUNGEON |
        MOB_FREQ_COMMON |
        MOB_MOD_ENLARGE | MOB_MOD_WEAPON | MOB_MOD_ARMOR |
        MOB_THEME_CRITTER | MOB_THEME_PRIMITIVE | MOB_THEME_MARTIAL |
        MOB_GROUPING_SOLO | MOB_GROUPING_PAIRS | MOB_GROUPING_TROOP | MOB_GROUPING_CREW | MOB_GROUPING_SWARM
    },
    1,
    {
      4, 1,
      ROOM_SIZE_LARGE | ROOM_LAYOUT_ROOM | ROOM_PLACING_E |
        ROOM_PURPOSE_START | ROOM_SHAPE_SQUARE,
      {&ROOM_TEMPLATES[3]}
    },
    MN_GRID,
  }
};

static map_node_data_t room_nodes[MAP_NODE_DONE] = {
  {MN_GRID, MAP_NODE_ROOT,NULL,6,{MN_ANCHORS,MN_GRAPH,MN_GRID_GEN,MN_BUILD, MN_DETAIL, MN_CHECK_MAP}},
  {MN_ANCHORS, MAP_NODE_SEQUENCE,NULL,2,{MN_GENERATE_ROOMS,MN_LAYOUT }},
  {MN_GENERATE_ROOMS, MAP_NODE_LEAF, LeafMapGenerateRooms ,0},
  {MN_GRID_GEN, MAP_NODE_SEQUENCE, NULL,3,{MN_APPLY_NODES, MN_COMPUTE_BOUNDS,MN_ALLOCATE_TILES,}},
  {MN_LAYOUT, MAP_NODE_LEAF, LeafMapGridLayout ,0},
  {MN_APPLY_SHAPES,MAP_NODE_LEAF, LeafMapApplyRoomShapes,0},
  {MN_PLACE_ROOMS, MAP_NODE_LEAF, LeafMapPlaceSubrooms,0}, 
  {MN_COMPUTE_BOUNDS, MAP_NODE_LEAF, LeafMapComputeBounds,0}, 
  {MN_ALLOCATE_TILES, MAP_NODE_LEAF, LeafMapAllocateTiles,0}, 
  {MN_CARVE_TILES, MAP_NODE_LEAF, LeafMapCarveTiles,0},
  {MN_GRAPH_ROOTS, MAP_NODE_LEAF, LeafMapGraphNodes,0},
  {MN_BUILD, MAP_NODE_SEQUENCE, NULL, 1,{MN_CARVE_TILES }}, 
  {MN_DETAIL, MAP_NODE_SEQUENCE, NULL, 5,{MN_ECO, MN_ENCASE_FLOORS, MN_PLACE_POI,MN_ENH, MN_SET_PLAYER}},
  {MN_ENCASE_FLOORS, MAP_NODE_LEAF, LeafMapFillWalls,0},
  {MN_PLACE_POI, MAP_NODE_SEQUENCE, NULL,1,{MN_PLACE_SPAWNS}},
  {MN_SET_PLAYER, MAP_NODE_LEAF, LeafMapPlayerSpawn,0},
  {MN_PLACE_SPAWNS, MAP_NODE_LEAF, LeafMapPlaceSpawns,0},
  {MN_ALIGN_ROOMS, MAP_NODE_LEAF, LeafMapAlignNodes,0},
  {MN_CLEANUP, MAP_NODE_SEQUENCE, NULL, 1,{MN_ALIGN_ROOMS,}},
  {MN_APPLY_NODES, MAP_NODE_LEAF, LeafMapNodesToGrid,0},
  {MN_PATHS, MAP_NODE_LEAF, LeafMapCheckPaths,0},
  {MN_CHECK_MAP, MAP_NODE_SEQUENCE, NULL, 3,{MN_PATHS, MN_ISSUES, MN_FIX}},
  {MN_ISSUES, MAP_NODE_LEAF, LeafMapFixIssues, 0},
  {MN_GRAPH, MAP_NODE_SEQUENCE, NULL, 1, { MN_GRAPH_ROOTS}},
  {MN_FIX, MAP_NODE_LEAF, LeafMapApplyFixes,0},
  {MN_ECO, MAP_NODE_LEAF, LeafMapBuildBiome,0},
  {MN_ENH, MAP_NODE_LEAF, LeafMapEnhance,0},
};

static const ItemInstance room_items[GEAR_DONE] = {
  {GEAR_MACE, ITEM_WEAPON, WEAP_MACE,PROP_QUAL_TRASH, PROP_WEAP_SIMP},
  {GEAR_LEATHER_ARMOR,ITEM_ARMOR,ARMOR_LEATHER,PROP_QUAL_POOR, PROP_WEAP_SIMP},
  {GEAR_LEATHER_CAP, ITEM_ARMOR,ARMOR_LEATHER,PROP_QUAL_STANDARD, PROP_WEAP_SIMP},
  {GEAR_CLUB, ITEM_WEAPON, WEAP_MACE,PROP_QUAL_TRASH, PROP_WEAP_SIMP},
  {GEAR_HAND_AXE, ITEM_WEAPON, WEAP_AXE,PROP_QUAL_TRASH, PROP_WEAP_SIMP},
  {GEAR_CLOTH_ARMOR,ITEM_ARMOR,ARMOR_PADDED,PROP_QUAL_TRASH, PROP_WEAP_SIMP},
  {GEAR_DAGGER, ITEM_WEAPON, WEAP_DAGGER,PROP_QUAL_TRASH, PROP_WEAP_SIMP},
  {GEAR_BOW_LIGHT,ITEM_WEAPON, WEAP_BOW,PROP_QUAL_STANDARD, PROP_WEAP_SIMP},
  {GEAR_POT_HEALTH, ITEM_CONSUMABLE, CONS_POT, PROP_QUAL_POOR, PROP_CONS_HEAL},
  {GEAR_PICK, ITEM_WEAPON, WEAP_PICK, PROP_QUAL_TRASH, PROP_WEAP_SIMP},
  {GEAR_HAMMER_LIGHT, ITEM_WEAPON, WEAP_MACE,PROP_QUAL_TRASH, PROP_WEAP_LIGHT | PROP_WEAP_THROW},
  {GEAR_BANDOLIER, ITEM_CONTAINER, INV_SLING, PROP_QUAL_FINE | PROP_MAT_LEATHER, PROP_CONT_PHIAL}
};

typedef struct {
  BehaviorID           id;
  bool                 is_root;
  BehaviorTreeType     bt_type;
  behavior_tree_node_t *(*func)(behavior_params_t *);
  bool          param_overide;
  EntityState   state;
  int           num_children;
  BehaviorID   children[5];
} BehaviorData;

static const BehaviorData room_behaviors[ BN_COUNT] = {
  { BN_NONE},
  { BN_CHANGE_STATE ,false,BT_LEAF,LeafChangeState},
  { BN_GET_TARGET ,false,BT_LEAF,LeafAcquireTarget},
  { BN_GET_DEST,false,BT_LEAF,LeafAcquireDestination},
  { BN_MOVE_TO_TARGET ,false,BT_LEAF,LeafMoveToTarget},
  { BN_MOVE_TO_DEST, false, BT_LEAF,LeafMoveToDestination},
  {BN_ATTACK,false,BT_LEAF,LeafAttackTarget},
  { BN_MOVE,false,BT_SEQUENCE, NULL,true, STATE_STANDBY,2,{ BN_GET_DEST, BN_MOVE_TO_DEST,BN_CHANGE_STATE}},
  { BN_ACQUIRE,false, BT_SEQUENCE, NULL,true, STATE_AGGRO,2,{ BN_GET_TARGET, BN_CHANGE_STATE}},
  {BN_CLEAR_CTRL, false, BT_LEAF, LeafClearState},
  {BN_IDLE, true, BT_SEQUENCE, NULL, false, 0, 2,
    { BN_CLEAR_CTRL, BN_PRIO}},
  { BN_SEEK, false, BT_SELECTOR,NULL,true,STATE_STANDBY,3,
    { BN_SEEK_RESOURCE, BN_ACQUIRE,  BN_CHANGE_STATE}},
  {BN_CHECK_SENSE, false, BT_LEAF, LeafCheckSenses},
  {BN_SPAWN, true, BT_SEQUENCE,  NULL, false, 0, 2, { BN_PREPARE_GEAR, BN_PREPARE_ABILITIES}},
  {BN_CHECK_NEEDS, false, BT_LEAF, LeafCheckNeeds},
  {BN_FILL_NEEDS, false, BT_LEAF, LeafFillNeeds},
  {BN_NEEDS, false, BT_SEQUENCE, NULL, true, STATE_REQ, 3, {BN_CHECK_NEEDS, BN_FILL_NEEDS, BN_CHANGE_STATE}},
  {BN_PREPARE_GEAR, false, BT_LEAF, LeafCheckInventory},
  {BN_PREPARE_ABILITIES, false, BT_LEAF, LeafCheckAbilities},
  {BN_REQ, true, BT_SELECTOR, NULL, true, STATE_IDLE, 3,
    {
      BN_FILL_NEED, BN_TRACK_RESOURCE, BN_CHANGE_STATE}},
  {BN_SEEK_RESOURCE, false, BT_LEAF, LeafSeekResource},
  {BN_FILL_NEED, false, BT_SEQUENCE, NULL, true, STATE_NEED, 3,
    { BN_SEEK_RESOURCE, BN_MOVE_TO_DEST, BN_CHANGE_STATE}},
  {BN_NEED, true, BT_SELECTOR, NULL, true, STATE_IDLE, 3,
    {BN_RES_REQ, BN_HUNT, BN_CHANGE_STATE}},
  {BN_CHECK_NEED, false, BT_SEQUENCE, LeafCheckNeed},
  {BN_TRACK, false, BT_SEQUENCE, NULL, true, STATE_NEED, 3, {BN_TRACK_RESOURCE, BN_MOVE_TO_DEST, BN_CHANGE_STATE}},
  {BN_TRACK_RESOURCE, false, BT_LEAF, LeafTrackResource},
  {BN_RES_REQ, false, BT_SEQUENCE, NULL, true, STATE_STANDBY, 3,
    {BN_CHECK_RES, BN_GET_RES, BN_CHANGE_STATE}},
  {BN_CHECK_RES, false, BT_LEAF, LeafCheckResource},
  {BN_GET_RES, false, BT_LEAF, LeafAcquireResource},
  {BN_HUNT, false, BT_SEQUENCE, NULL, true, STATE_AGGRO, 2,
    {BN_TARGET_GOAL, BN_CHANGE_STATE}},
  {BN_TARGET_GOAL, false, BT_LEAF, LeafTargetGoal},
  {BN_CAN_ATTACK, false, BT_LEAF, LeafCanAttackTarget},
  {BN_AGGRO, true, BT_SELECTOR, NULL, true, STATE_IDLE, 3,
    {BN_ENGAGE, BN_FLEE , BN_CHANGE_STATE}},
  {BN_ENGAGE, false, BT_SEQUENCE, NULL, true, STATE_ATTACK, 3,
    {BN_CHECK_TARGET, BN_TRY_ATTACK, BN_CHANGE_STATE}},
  {BN_GET_AGGRO, false, BT_SEQUENCE, NULL, true, STATE_ATTACK, 3,
    {BN_CHECK_AGGRO, BN_MOVE_TO_TARGET, BN_CHANGE_STATE}},
  {BN_CHECK_AGGRO, false, BT_LEAF, LeafCheckAggro},
  {BN_TRY_ATTACK, false, BT_SEQUENCE,NULL,true, STATE_ATTACK,3,
    {BN_GET_TARGET,BN_CAN_ATTACK,BN_CHANGE_STATE}},
  {BN_COMBAT, true, BT_SELECTOR, NULL, true, STATE_IDLE, 2,
    { BN_QUEUE_ATTACK, BN_CHANGE_STATE}},
  {BN_PRIO, false, BT_SEQUENCE, NULL, false, 0, 3,
    {BN_CHECK_PRIO, BN_GET_PRIO, BN_CHANGE_STATE}},
  {BN_GET_PRIO, false, BT_LEAF, LeafGetPriority},
  {BN_CHECK_PRIO, false, BT_LEAF, LeafCheckPriority},
  {BN_QUEUE_ATTACK, false, BT_SEQUENCE, NULL, true, STATE_STANDBY, 3,
    { BN_CHECK_COMBAT, BN_ATTACK,BN_CHANGE_STATE}},
  {BN_CHECK_COMBAT, false, BT_LEAF, LeafCombatCheck},
  {BN_FLEE, false, BT_SEQUENCE, NULL, true, STATE_STANDBY, 3,
    {BN_FIND_SAFE, BN_MOVE_TO_DEST, BN_CHANGE_STATE}},
  {BN_CHECK_TARGET, false, BT_LEAF, LeafCheckTarget},
  {BN_FIND_SAFE, false, BT_LEAF, LeafFindSafe}
};
#endif
